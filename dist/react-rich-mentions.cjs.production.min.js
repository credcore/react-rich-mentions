"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var e,t=require("react"),n=(e=t)&&"object"==typeof e&&"default"in e?e.default:e;function r(){return(r=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var r in n)Object.prototype.hasOwnProperty.call(n,r)&&(e[r]=n[r])}return e}).apply(this,arguments)}var i=function(){},o={getTransformedValue:function(){return""},insertFragment:i,setValue:i,activeSearch:"",inputElement:null,setInputElement:i,selectItem:i,setActiveItemIndex:i,opened:null,index:0,loading:!1,results:[],closeAutocomplete:i,openAutocomplete:i,onBeforeChanges:i,onKeyDown:i,onChanges:i,fixed:!0,setPositionFixed:i},a=t.createContext(o);function u(e){return e.nodeType===Node.TEXT_NODE?e.parentElement:e}function c(e){var t=u(e);return t&&t.hasAttribute("data-rich-mentions")?t:null}function l(e,t){var n=document.getSelection(),r=document.createRange();r.setStart(e,t),r.collapse(!0),n&&(n.removeAllRanges(),n.addRange(r))}function s(e,t,n){void 0===n&&(n="after");var r=document.createTextNode(t.replace(/\s/g," ")),i=e.parentElement;i&&(i.insertBefore(r,"after"===n?e.nextSibling:e),l(r,t.length))}function f(e,t){for(var n=!1,r=null,i=0;i<e.rangeCount;++i){var o=e.getRangeAt(i);o.startContainer===o.endContainer&&o.startOffset===o.endOffset||(n=!0,r=o,o.deleteContents())}if(null!=t&&t.data&&r){var a=document.createTextNode(t.data);r.insertNode(a),l(a,1),t.preventDefault()}return n}function d(e,t,n){var r=t.replace(n.match,n.matchDisplay).replace(/\s/g," ");if(e.textContent=r,e.setAttribute("data-rich-mentions",t),e.setAttribute("spellcheck","false"),n.customizeFragment&&n.customizeFragment(e,!0),e.setAttribute("data-integrity",e.innerHTML),e.parentElement){var i=document.createTextNode(" ");e.parentElement.insertBefore(i,e.nextSibling),l(i,1)}}function m(e,t){Array.from(e.children).forEach((function e(n,r){var i=n.parentElement;if(n instanceof HTMLBRElement){if(1!==i.children.length&&r!==i.children.length-1){var o=document.createElement("div");i.insertBefore(o,n),o.appendChild(n)}}else if(n instanceof HTMLDivElement&&!n.attributes.length)Array.from(n.children).forEach(e);else{var a=n.textContent||"";if(!(n instanceof Text||n.hasAttribute("data-rich-mentions")))return i.insertBefore(document.createTextNode(a),n),void i.removeChild(n);n.hasAttribute("data-integrity")?n.getAttribute("data-integrity")!==n.innerHTML&&i.removeChild(n):t.some((function(e){return a.match(e.query)}))||(i.insertBefore(document.createTextNode(a),n.nextSibling),i.removeChild(n))}}))}var h=function(e){return/(\u00A0|\s)/.test(e)},p=function(e,t,n,r){if(t>0)return!h(e.charAt(t-1));if(["DIV","BR"].includes(n.nodeName))return!1;if(n.previousSibling){var i=n.previousSibling.textContent||"";return!!i.length&&!h(i.charAt(i.length-1))}return r},g=function(e,t,n){if(t<e.length)return!h(e.charAt(e.length-1));if(!n.nextSibling)return!0;var r=n.nextSibling.textContent||"";return!r.length||!h(r.charAt(0))},v=function(e,t){var n=u(e);t.contains(n)&&t!==n&&n&&n.hasAttribute("data-integrity")&&t.removeChild(n)};exports.RichMentionsAutocomplete=function(e){var r=e.fixed,i=void 0===r||r,o=e.className,u=e.itemClassName,c=e.selectedItemClassName,l=t.useContext(a),s=l.opened,f=l.index,d=l.results,m=l.setActiveItemIndex,h=l.selectItem,p=l.setPositionFixed,g=function(e){return function(){return h(e)}},v=function(e){return function(){return m(e)}},x={};return t.useEffect((function(){p(i)}),[i,p]),s&&d.length?n.createElement("div",Object.assign({},{},{className:""+o,style:{position:i?"fixed":"absolute",left:s.x+"px",top:s.y+"px"}}),n.createElement("div",{className:"autocomplete-list",style:{bottom:s.bottom?"0px":"auto",right:s.right?"0px":"auto"}},d.map((function(e,t){return n.createElement("button",Object.assign({className:u+" "+(t===f?c:""),type:"button",key:e.ref,onClick:g(e),onMouseOver:v(f)},x),e.name)})))):null},exports.RichMentionsContext=a,exports.RichMentionsInput=function(e){var i=e.defaultValue,o=e.singleLine,u=e.onEnter,c=function(e,t){if(null==e)return{};var n,r,i={},o=Object.keys(e);for(r=0;r<o.length;r++)t.indexOf(n=o[r])>=0||(i[n]=e[n]);return i}(e,["defaultValue","singleLine","onEnter"]),l=t.useRef(null),s=t.useContext(a),f=s.setInputElement,d=s.onBeforeChanges,m=s.onKeyDown,h=s.onChanges,p=s.getInitialHTML,g=s.opened;null===l.current&&i&&p&&(l.current=p(i));var v={outline:0};return o&&(v=r({},v,{whiteSpace:"nowrap",overflow:"hidden"})),n.createElement("div",Object.assign({ref:f},c,{contentEditable:!0,onBeforeInput:function(e){d(e),c.onBeforeInput&&c.onBeforeInput(e)},onKeyDown:function(e){"Enter"===e.key&&(u&&!g&&setTimeout((function(){u()}),200),o&&e.preventDefault()),m(e),c.onKeyDown&&c.onKeyDown(e)},onInput:function(e){c.onInput&&c.onInput(e),h(e)},dangerouslySetInnerHTML:{__html:l.current||""},style:v}))},exports.RichMentionsProvider=function(e){var i=e.children,x=e.configs,b=e.getContext,C=e.onUpdate,E=e.getInitialHTML,A=void 0===E?function(e){return function(t){return function(e){var t=document.createElement("div");return t.innerHTML=e,function e(t){Array.from(t.childNodes).forEach((function(t){t instanceof Text&&t.nodeValue?t.nodeValue=t.nodeValue.replace(/( |\t)/g," "):t instanceof HTMLElement&&(e(t),t.hasAttribute("data-rich-mentions")&&!t.hasAttribute("data-integrity")&&t.setAttribute("data-integrity",t.innerHTML))}))}(t),t.innerHTML}(e.reduce((function(e,t){return e.replace(t.match,(function(e){var n=document.createElement("span");return d(n,e,t),n.outerHTML}))}),t))}}(x):E,y=t.useRef(r({},o,{getInitialHTML:A,setPositionFixed:function(e){M({fixed:e})},setInputElement:function(e){M({inputElement:e})},selectItem:function(e){var t=y.current.opened;null!=t&&t.element&&d(t.element,e.ref,t.config),M({index:0,results:[],opened:null,loading:!1,activeSearch:""})},onBeforeChanges:function(e){var t=document.getSelection();t&&t.anchorNode&&(!f(t,e)||(t=document.getSelection())&&t.anchorNode)&&(function(e,t){if(!e.defaultPrevented)for(var n=e.data,r=e.currentTarget,i=0;i<t.rangeCount;i++){var o=t.getRangeAt(i);if(o.startContainer===o.endContainer){var a=u(o.startContainer);if(!r.contains(a))continue;if(o.startContainer instanceof Text&&0===o.startOffset){var c=o.startContainer.previousSibling,l=o.startContainer.previousElementSibling;if(c&&l&&c===l&&l.hasAttribute("data-rich-mentions")&&!l.hasAttribute("data-integrity")){l.appendChild(document.createTextNode(n)),e.preventDefault();continue}}if(!a||r===a||!a.hasAttribute("data-rich-mentions"))continue;if(0===o.endOffset){s(a,n,"before"),e.preventDefault();continue}if(a.hasAttribute("data-integrity")&&o.startOffset===(a.textContent||"").length){s(a,n,"after"),e.preventDefault();continue}}}}(e,t),function(e,t){if(!e.defaultPrevented)for(var n=e.currentTarget,r=0;r<t.rangeCount;r++){var i=t.getRangeAt(r);v(i.startContainer,n),v(i.endContainer,n)}}(e,t),function(e,t,n){var r=t.anchorNode;if(!e.defaultPrevented&&r){var i=c(r);if(i){var o=e.data,a=i.textContent+o;n.some((function(e){var t=a.match(e.query);return t&&t[0]===t.input}))||(e.preventDefault(),s(i,o))}}}(e,t,x),function(e,t,n,r){var i=t.anchorNode,o=t.anchorOffset;if(!e.defaultPrevented&&i&&!c(i)){var a=e.data,u=i.textContent||"",s=u.substr(0,o)+a+u.substr(o),f=n.find((function(e){return s.match(e.query)}));if(f){var d=s.match(f.query),m=d.index||0,h=s.substr(0,m);if(!(h.length&&!/\W$/.test(h)||o<m||o>=m+d[0].length)){i.textContent=h;var p=document.createElement("span"),g=d[0].substr(0,o-m+a.length),v=s.substr(m+g.length);p.setAttribute("data-rich-mentions",""),p.setAttribute("spellcheck","false"),p.textContent=g,f.customizeFragment&&f.customizeFragment(p,!1);var x=document.createTextNode(/^\s/.test(v)?v:" "+v),b=e.currentTarget===i,C=b?i:i.parentElement;C&&(b?(C.appendChild(p),C.appendChild(x)):(C.insertBefore(x,i.nextSibling),C.insertBefore(p,i.nextSibling))),e.preventDefault(),l(p.childNodes[0],o-h.length+1),r.openAutocomplete(p,g,f)}}}}(e,t,x,y.current),m(e.currentTarget,x))},onChanges:function(){var e=y.current,t=e.inputElement,n=e.openAutocomplete,r=e.closeAutocomplete,i=document.getSelection();t&&m(t,x);var o=(null==i?void 0:i.anchorNode)&&c(i.anchorNode);if(o&&!o.hasAttribute("data-integrity")){var a=o.textContent||"",u=x.find((function(e){return a.match(e.query)}));u&&n(o,a,u)}else y.current.opened&&r();C&&C(B())},onKeyDown:function(e){var t=y.current,n=t.results,r=t.index,i=t.selectItem,o=t.closeAutocomplete;if(t.opened&&n.length)switch(e.keyCode){case 40:e.preventDefault(),M({index:Math.min(r+1,n.length-1)});break;case 38:e.preventDefault(),M({index:Math.max(r-1,0)});break;case 9:case 13:n[r]&&(e.preventDefault(),i(n[r]));break;case 27:o()}},closeAutocomplete:function(){M({opened:null,loading:!1,results:[],index:0,activeSearch:""})},openAutocomplete:function(e,t,n){var r=e.getBoundingClientRect(),i={top:0,right:0,bottom:0,left:0};y.current.inputElement&&(i=y.current.inputElement.getBoundingClientRect()),M({loading:!0,index:0,opened:{config:n,fixed:!0,bottom:!0,right:!0,element:e,x:r.right-i.left,y:r.bottom-i.top},activeSearch:t});var o=function(t){var n;void 0===t&&(t=[]),(null==(n=y.current.opened)?void 0:n.element)===e&&M({results:t,loading:!1})},a=n.onMention(t,o);a instanceof Promise?a.then(o,o):a instanceof Array&&o(a)},setActiveItemIndex:function(e){M({index:e})},getTransformedValue:B,insertFragment:function(e,t){void 0===t&&(t=null),function(e,t,n,r){var i=n.find((function(t){return e.match(t.match)}));if(r&&(i||t)){var o=null,a=null,u=!1,s=!1,v=document.getSelection();if(v&&v.anchorNode&&r.contains(v.anchorNode)){var x=v.anchorNode,b=v.anchorOffset,C=c(x);if(f(v),C&&b===(x.textContent||"").length&&(C.nextSibling||r.insertBefore(document.createTextNode(""),null),x=C.nextSibling,b=0,C=null),C)if(C.hasAttribute("data-integrity")){var E;a=C.nextSibling,null==(E=C.parentElement)||E.removeChild(C)}else{var A=x.textContent||"";if(b>0&&b<A.length){var y=A.substr(0,b),T=A.substr(b),N=document.createTextNode(T);r.insertBefore(N,C.nextSibling),x.textContent=y,u=!0,a=N}u=p(A,b,x,u),s=g(A,b,x)}else{var S=x.textContent||"";if(b>0)o=x;else{var M=x;!S&&"DIV"===M.nodeName&&!M.attributes.length&&1===M.childNodes.length&&M.firstElementChild instanceof HTMLBRElement?M.previousSibling instanceof HTMLDivElement?(a=x,M.removeChild(M.firstElementChild)):(o=x,M.removeChild(M.firstElementChild)):a=x}if(b>0&&b<S.length){var I,B=S.substr(0,b),D=S.substr(b);S=B,x.textContent=B,null==(I=x.parentElement)||I.insertBefore(document.createTextNode(D),x.nextSibling)}u=p(S,b,x,u),s=g(S,b,x)}}else{var L=r.textContent||"";s=!0,u=!h(L.charAt(L.length-1))}var H,O=document.createElement("span");if(i?d(O,e,i):t&&(O.appendChild(t),O.setAttribute("data-rich-mentions",e),O.setAttribute("data-integrity",O.innerHTML),O.setAttribute("spellcheck","false")),o&&o!==r)null==(H=o.parentElement)||H.insertBefore(O,o.nextSibling);else if(a&&a!==r){var R;null==(R=a.parentElement)||R.insertBefore(O,a)}else r.appendChild(O);if(u){var w,P=document.createTextNode(" ");null==(w=O.parentElement)||w.insertBefore(P,O)}if(s){var V,j=document.createTextNode(" ");null==(V=O.parentElement)||V.insertBefore(j,O.nextSibling)}O.nextSibling&&l(O.nextSibling,s?1:0),m(r,n)}}(e,t,x,y.current.inputElement)},setValue:function(e){var t=y.current,n=t.inputElement,r=t.closeAutocomplete;n&&(n.innerHTML=A(e),m(n,x)),r()}})),T=t.useState(y.current),N=T[0],S=T[1],M=function(e){y.current=r({},y.current,e),S(y.current)};function I(){var e=y.current,t=e.inputElement,n=e.opened,r=e.closeAutocomplete,i=e.openAutocomplete,o=e.getTransformedValue,a=document.getSelection(),u=(null==a?void 0:a.anchorNode)&&(c(a.anchorNode)||0===a.anchorOffset&&a.anchorNode.previousSibling&&c(a.anchorNode.previousSibling)),l=u&&!u.hasAttribute("data-integrity")&&t&&t.contains(u);if(n&&!l)r();else if(l&&u&&(!n||n.element!==u)){var s=u.textContent||"",f=x.find((function(e){return s.match(e.query)}));f&&i(u,s,f)}C&&C(o())}function B(){return function(e){if(!e||"<br>"===e.innerHTML)return"";var t="_br_"+Date.now()+"_",n=new RegExp("\\n?"+t+"\\n?","g");return Array.from(e.childNodes).map((function(e){return function e(t,n){if(t instanceof Text)return t.textContent||"";if(t instanceof HTMLBRElement)return n;if(t instanceof Element){var r=t.getAttribute("data-rich-mentions");if(r)return r;var i=t instanceof HTMLDivElement?"\n":"";return""+i+Array.from(t.childNodes).map((function(t){return e(t,n)})).join("")+i}return""}(e,t)})).join("").replace(/\u00A0/g," ").replace(/\n{2,}/g,"\n").replace(n,"\n").trim()}(y.current.inputElement)}return t.useEffect((function(){return document.addEventListener("selectionchange",I,!1),function(){document.removeEventListener("selectionchange",I,!1)}})),t.useEffect((function(){"function"==typeof b?b(N):"object"==typeof b&&(b.current=N)}),[b,N]),n.createElement(a.Provider,{value:N},i)},exports.initialContext=o;
//# sourceMappingURL=react-rich-mentions.cjs.production.min.js.map
